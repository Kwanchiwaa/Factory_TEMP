<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Real-Time Sensor Dashboard</title>
  <script src="https://cdn.socket.io/4.0.0/socket.io.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/gaugeJS/dist/gauge.min.js"></script>
  <style>
    body {
      font-family: sans-serif;
      text-align: center;
      background: #f5f5f5;
    }
    h1 {
      margin-top: 20px;
    }
    .dashboard {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 30px;
      margin: 20px auto;
    }
    canvas {
      background: white;
      border-radius: 12px;
      padding: 10px;
    }
    .gauge-group {
      display: flex;
      justify-content: center;
      gap: 20px;
    }
    .gauge-container {
      width: 180px;
    }
    .value-label {
      font-size: 18px;
      margin-top: 5px;
    }
    .chart-container {
      width: 600px;
      height: 250px;
    }
  </style>
</head>
<body>

<h1>Real-Time Sensor Dashboard</h1>

<div class="dashboard">
  <div class="chart-container">
    <canvas id="sensorChart"></canvas>
  </div>

  <div class="gauge-group">
    <div class="gauge-container">
      <canvas id="tempGauge"></canvas>
      <div class="value-label" id="temperature">0 °C</div>
    </div>
    <div class="gauge-container">
      <canvas id="humiGauge"></canvas>
      <div class="value-label" id="humidity">0 %</div>
    </div>
    <div class="gauge-container">
      <canvas id="pmGauge"></canvas>
      <div class="value-label" id="pm25">0 µg/m³</div>
    </div>
  </div>
</div>

<script>
  const socket = io.connect();

  // ตั้งค่า Chart.js (กราฟเดียวรวม 3 เส้น)
  const sensorChart = new Chart(document.getElementById('sensorChart'), {
    type: 'line',
    data: {
      labels: [],
      datasets: [
        { label: 'Temperature (°C)', data: [], borderColor: 'red', fill: false, pointRadius: 0 },
        { label: 'Humidity (%)', data: [], borderColor: 'blue', fill: false, pointRadius: 0 },
        { label: 'PM2.5 (µg/m³)', data: [], borderColor: 'green', fill: false, pointRadius: 0 }
      ]
    },
    options: {
      animation: false,
      responsive: true,
      maintainAspectRatio: false,
      scales: {
        x: { display: false },
        y: { beginAtZero: true }
      }
    }
  });

  // สร้างเกจ
  function createGauge(canvas, min, max) {
    return new Gauge(canvas).setOptions({
      angle: 0,
      lineWidth: 0.2,
      radiusScale: 0.9,
      pointer: { length: 0.6, color: '#000' },
      colorStart: '#6FADCF',
      colorStop: '#8FC0DA',
      strokeColor: '#E0E0E0',
      highDpiSupport: true
    }).set({ min: min, max: max });
  }

  const tempGauge = createGauge(document.getElementById('tempGauge'), 0, 50);
  const humiGauge = createGauge(document.getElementById('humiGauge'), 0, 100);
  const pmGauge = createGauge(document.getElementById('pmGauge'), 0, 300);

  // อัปเดตข้อมูล real-time
  socket.on('sensor_data', function(data) {
    const now = new Date().toLocaleTimeString();
    const value = parseFloat(data.value);

    if (data.topic === 'sensor/temperature') {
      document.getElementById('temperature').innerText = value + " °C";
      tempGauge.set(value);
      updateChart(0, value, now);

    } else if (data.topic === 'sensor/humidity') {
      document.getElementById('humidity').innerText = value + " %";
      humiGauge.set(value);
      updateChart(1, value, now);

    } else if (data.topic === 'sensor/pm25') {
      document.getElementById('pm25').innerText = value + " µg/m³";
      pmGauge.set(value);
      updateChart(2, value, now);
    }
  });

  // อัปเดตกราฟ
  function updateChart(datasetIndex, value, label) {
    const chart = sensorChart;
    if (chart.data.labels.length >= 20) {
      chart.data.labels.shift();
      chart.data.datasets.forEach(ds => ds.data.shift());
    }
    if (chart.data.labels.length === 0 || chart.data.labels[chart.data.labels.length-1] !== label) {
      chart.data.labels.push(label);
    }
    chart.data.datasets[datasetIndex].data.push(value);
    chart.update();
  }
</script>

</body>
</html>
