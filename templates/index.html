const socket = io.connect();

// Chart.js แบบเรียลไทม์
const sensorChart = new Chart(document.getElementById('sensorChart'), {
  type: 'line',
  data: {
    labels: [],
    datasets: [
      { label: 'Temperature (°C)', data: [], borderColor: 'red', fill: false, pointRadius: 0 },
      { label: 'Humidity (%)', data: [], borderColor: 'blue', fill: false, pointRadius: 0 },
      { label: 'PM2.5 (µg/m³)', data: [], borderColor: 'green', fill: false, pointRadius: 0 }
    ]
  },
  options: {
    animation: false,
    responsive: true,
    maintainAspectRatio: false,
    scales: {
      x: {
        display: true,
        title: { display: true, text: 'Time' }
      },
      y: {
        beginAtZero: true
      }
    },
    plugins: {
      legend: { labels: { boxWidth: 12 } }
    }
  }
});

// เกจ 3 ตัว
function createGauge(canvas, min, max) {
  const opts = {
    angle: 0,
    lineWidth: 0.2,
    radiusScale: 0.9,
    pointer: { length: 0.6, color: '#333' },
    limitMax: true,
    limitMin: true,
    colorStart: '#6FADCF',
    colorStop: '#8FC0DA',
    strokeColor: '#E0E0E0',
    highDpiSupport: true
  };
  const gauge = new Gauge(canvas).setOptions(opts);
  gauge.maxValue = max;
  gauge.setMinValue(min);
  gauge.animationSpeed = 32;
  gauge.set(0);
  return gauge;
}

const tempGauge = createGauge(document.getElementById('tempGauge'), 0, 50);
const humiGauge = createGauge(document.getElementById('humiGauge'), 0, 100);
const pmGauge = createGauge(document.getElementById('pmGauge'), 0, 300);

// อัปเดตข้อมูลเมื่อรับจาก MQTT ผ่าน SocketIO
socket.on('sensor_data', function(data) {
  console.log("Received Data: ", data);

  const tempValue = data.temperature;
  const humiValue = data.humidity;
  const pmValue = data.pm25;

  // อัปเดตตัวเลข
  document.getElementById('temperature').innerText = tempValue + " °C";
  document.getElementById('humidity').innerText = humiValue + " %";
  document.getElementById('pm25').innerText = pmValue + " µg/m³";

  // อัปเดตเกจ
  tempGauge.set(tempValue);
  humiGauge.set(humiValue);
  pmGauge.set(pmValue);

  // อัปเดตกราฟ
  const now = new Date().toLocaleTimeString();
  const chartData = sensorChart.data;

  if (chartData.labels.length > 20) {
    chartData.labels.shift();
    chartData.datasets.forEach(ds => ds.data.shift());
  }

  chartData.labels.push(now);
  chartData.datasets[0].data.push(tempValue);
  chartData.datasets[1].data.push(humiValue);
  chartData.datasets[2].data.push(pmValue);

  sensorChart.update();
});
